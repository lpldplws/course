# 3.18内容

## 异步

浏览器是多进程的，浏览器每一个 tab 标签都代表一个独立的进程

对于浏览器内核（浏览器渲染进程）包括这几个线程：

- GUI 渲染线程:

    负责渲染页面，解析 HTML，CSS 构成 DOM 树等，当页面重绘或者由于某种操作引起回流都会调起该线程。
    和 JS 引擎线程是互斥的，当 JS 引擎线程在工作的时候，GUI 渲染线程会被挂起，GUI 更新被放入在 JS 任务队列中，等待 JS 引擎线程空闲的时候继续执行。

- JS 引擎线程:

    单线程工作，负责解析运行 JavaScript 脚本。
    和 GUI 渲染线程互斥，JS 运行耗时过长就会导致页面阻塞。

- 事件触发线程:

    当事件符合触发条件被触发时，该线程会把对应的事件回调函数添加到任务队列的队尾，等待 JS 引擎处理。

- 定时器触发线程:

    浏览器定时计数器并不是由 JS 引擎计数的，阻塞会导致计时不准确。
    开启定时器触发线程来计时并触发计时，计时完成后会被添加到任务队列中，等待 JS 引擎处理。

- http 请求线程:

    http 请求的时候会开启一条请求线程。
    请求完成有结果了之后，将请求的回调函数添加到任务队列中，等待 JS 引擎处理。

当在解析网页时遇到script标签，即有JS代码，渲染进程会把GUI线程保存在队列中，然后让JS引擎线程来处理JS代码，等到JS程序执行完毕，JS引擎空闲进行阻塞线程态时，GUI线程才会又开始工作，GUI更新会立即被执行。所以网页中JS脚本会阻塞网页的渲染。如果JS运行时间过长，就会造成页面的渲染不连贯。


## 关键渲染路径及优化

### 关键渲染路径

概念：从收到 HTML、CSS 和 JavaScript 字节到对其进行必需的处理，从而将它们转变成渲染像素的这一过程。

渲染路径有五大步骤：构建DOM -> 构建CSSOM -> 构建渲染树 -> 布局 -> 绘制

#### 构建DOM

- 转换： 浏览器从磁盘或网络读取 HTML 的原始字节，并根据文件的指定编码（例如 UTF-8）将它们转换成各个字符。
- 令牌化(TOKEN)： 浏览器将字符串转换成 W3C HTML5 标准规定的各种令牌，例如，`<html>`、`<body>`，以及其他尖括号内的字符串。每个令牌都具有特殊含义和一组规则。
- 词法分析： 发出的令牌转换成定义其属性和规则的“对象”。
- DOM 构建： 最后，由于 HTML 标记定义不同标记之间的关系（一些标记包含在其他标记内），创建的对象链接在一个树数据结构内，此结构也会捕获原始标记中定义的父项-子项关系：HTML 对象是 body 对象的父项，body 是 paragraph 对象的父项，依此类推。

![构建DOM](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/full-process.png?hl=zh-cn)

整个流程的最终输出是我们这个简单页面的文档对象模型 (DOM)，浏览器对页面进行的所有进一步处理都会用到它。

#### 构建CSSOM

与处理 HTML 时一样，我们需要将收到的 CSS 规则转换成某种浏览器能够理解和处理的东西。因此，我们会重复 HTML 过程，不过是为 CSS 而不是 HTML：

可以理解为与构建DOM并行处理。

![构建CSSOM](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/cssom-construction.png?hl=zh-cn)

CSSOM 为何具有树结构？为页面上的任何对象计算最后一组样式时，浏览器都会先从适用于该节点的最通用规则开始（例如，如果该节点是 body 元素的子项，则应用所有 body 样式），然后通过应用更具体的规则（即规则“向下级联”）以递归方式优化计算的样式。每个浏览器都提供一组默认样式（也称为“User Agent 样式”），即我们不提供任何自定义样式时所看到的样式。

#### 构建渲染树

渲染树只包含渲染网页所需的节点。

某些节点不可见（例如脚本标记、元标记等），因为它们不会体现在渲染输出中，所以会被忽略。

某些节点通过 CSS 隐藏，因此在渲染树中也会被忽略，

![渲染过程](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/render-tree-construction.png?hl=zh-cn)

#### 布局

布局流程的输出是一个“盒模型”，它会精确地捕获每个元素在视口内的确切位置和尺寸：所有相对测量值都转换为**屏幕上的绝对像素**。

#### 绘制

将渲染树中的每个节点转换成屏幕上的实际像素。这一步通常称为“绘制”或“栅格化”。

优化关键渲染路径就是指最大限度缩短执行上述第 1 步至第 5 步耗费的总时间

### 优化关键渲染路径

#### 阻塞渲染的CSS

在渲染树构建中，我们看到关键渲染路径要求我们同时具有 DOM 和 CSSOM 才能构建渲染树。这会给性能造成严重影响：HTML 和 CSS 都是阻塞渲染的资源。

HTML 显然是必需的，因为如果没有 DOM，我们就没有可渲染的内容。在默认情况下，CSS 也被视为阻塞渲染的资源。

我们可以通过媒体类型和媒体查询将一些 CSS 资源标记为不阻塞渲染。

```JS
<link href="style.css"    rel="stylesheet">
<link href="style.css"    rel="stylesheet" media="all">
<link href="portrait.css" rel="stylesheet" media="orientation:portrait">
<link href="print.css"    rel="stylesheet" media="print">
```

- 第一个声明阻塞渲染，适用于所有情况。
- 第二个声明同样阻塞渲染：“all”是默认类型，如果您不指定任何类型，则隐式设置为“all”。因此，第一个声明和第二个声明实际上是等效的。
- 第三个声明具有动态媒体查询，将在网页加载时计算。根据网页加载时设备的方向，portrait.css 可能阻塞渲染，也可能不阻塞渲染。
- 最后一个声明只在打印网页时应用，因此网页首次在浏览器中加载时，它不会阻塞渲染。

“阻塞渲染”仅是指浏览器是否需要暂停网页的首次渲染，直至该资源准备就绪。无论哪一种情况，浏览器仍会下载 CSS 资产，只不过不阻塞渲染的资源优先级较低罢了。

#### 使用 JavaScript 添加交互

JavaScript 执行将暂停，直至 CSSOM 就绪。

当浏览器遇到一个 script 标记时，DOM 构建将暂停，直至脚本完成执行。

向 script 标记添加异步关键字可以指示浏览器在等待脚本可用期间不阻止 DOM 构建

#### 优化关键渲染路径的常规步骤如下：

- 对关键路径进行分析和特性描述：资源数、字节数、长度。
- 最大限度减少关键资源的数量：删除它们，延迟它们的下载，将它们标记为异步等。
- 优化关键字节数以缩短下载时间（往返次数）。
- 优化其余关键资源的加载顺序：您需要尽早下载所有关键资产，以缩短关键路径长度。

## 参考：

- [关键渲染路径](https://developers.google.com/web/fundamentals/performance/critical-rendering-path?hl=zh-cn)
